---
phase: 02-source-registry
plan: 01
type: execute
domain: config
---

<objective>
Extend the source registry to include full channel metadata and source-specific API configuration.

Purpose: Phase 1 created genre mappings (channel-to-genre). Phase 2 adds the remaining metadata needed for a complete source registry: stream URLs, channel descriptions, images, and API endpoints. This enables Phase 4 to merge static config with live API data.

Output: Extended type system with `ChannelDefinition`, `SourceApiConfig`, updated source configs with channel metadata, and utility functions to look up channels.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-genre-taxonomy/01-01-SUMMARY.md
@src/config/types.ts
@src/config/genres.ts
@src/config/sources/index.ts
@src/config/sources/somafm.ts
@src/config/sources/radio-paradise.ts
@src/types/channel.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Extend type system with channel definitions and API config</name>
  <files>src/config/types.ts</files>
  <action>
Extend the existing types in `src/config/types.ts`:

1. Add `StreamDefinition` interface:
   - `quality`: 'high' | 'medium' | 'low'
   - `format`: 'mp3' | 'aac' | 'flac'
   - `bitrate`: number (kbps)
   - `url`: string (the stream URL template or direct URL)

2. Add `ChannelDefinition` interface (static channel metadata):
   - `id`: string (matches channelId in ChannelGenreMapping)
   - `title`: string
   - `description`: string
   - `dj`: string | null
   - `image`: { small: string; medium: string; large: string }
   - `streams`: readonly StreamDefinition[]
   - `homepage`: string | null

3. Add `SourceApiConfig` interface:
   - `channelsEndpoint`: string | null (e.g., 'https://api.somafm.com/channels.json')
   - `nowPlayingEndpoint`: string | null (e.g., 'https://api.somafm.com/channels.json' for SomaFM which embeds it)
   - `streamUrlTemplate`: string | null (e.g., 'https://ice{n}.somafm.com/{channelId}-128-mp3')
   - `proxyRequired`: boolean

4. Extend `SourceConfig` to include:
   - `api`: SourceApiConfig
   - `channelDefinitions`: readonly ChannelDefinition[]

Keep the existing `channels` field (genre mappings) - we need both.

Use `readonly` arrays and properties. Use `as const satisfies` pattern consistent with genres.ts.

Do NOT import from src/types/channel.ts - that's a separate type for runtime use. Keep config types self-contained.
  </action>
  <verify>npx tsc --noEmit (no type errors)</verify>
  <done>
    - StreamDefinition interface exists with quality, format, bitrate, url
    - ChannelDefinition interface exists with id, title, description, dj, image, streams, homepage
    - SourceApiConfig interface exists with channelsEndpoint, nowPlayingEndpoint, streamUrlTemplate, proxyRequired
    - SourceConfig extended with api and channelDefinitions fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SomaFM channel definitions with stream URLs</name>
  <files>src/config/sources/somafm.ts</files>
  <action>
Update SomaFM config to include channel definitions with metadata and streams.

For SomaFM:
- API config:
  - channelsEndpoint: 'https://api.somafm.com/channels.json'
  - nowPlayingEndpoint: 'https://api.somafm.com/channels.json' (same endpoint, nowPlaying embedded)
  - streamUrlTemplate: null (use streams from API or define static ones)
  - proxyRequired: true (CORS)

- Channel definitions: Add definitions for all 49 mapped channels.
  - Use SomaFM's standard URL patterns:
    - MP3 128k: `https://somafm.com/{id}128.pls` or direct: `https://ice1.somafm.com/{id}-128-mp3`
    - AAC 64k: `https://ice1.somafm.com/{id}-64-aac`
    - AAC 128k: `https://ice1.somafm.com/{id}-128-aac`
  - For images, use SomaFM patterns:
    - small: `https://somafm.com/img/{id}120.png`
    - medium: `https://somafm.com/img/{id}240.png`
    - large: `https://somafm.com/img/{id}512.png`
  - Leave description/dj as placeholder strings - Phase 4 will fetch from API
  - homepage: `https://somafm.com/{id}/`

Create a helper to generate channel definitions from just the channel ID to reduce boilerplate.

Structure:
```typescript
function createSomaFMChannel(id: string): ChannelDefinition {
  return {
    id,
    title: id, // Placeholder - API provides real title
    description: '', // Placeholder - API provides
    dj: null,
    image: {
      small: `https://somafm.com/img/${id}120.png`,
      medium: `https://somafm.com/img/${id}240.png`,
      large: `https://somafm.com/img/${id}512.png`,
    },
    streams: [
      { quality: 'high', format: 'aac', bitrate: 128, url: `https://ice1.somafm.com/${id}-128-aac` },
      { quality: 'medium', format: 'mp3', bitrate: 128, url: `https://ice1.somafm.com/${id}-128-mp3` },
      { quality: 'low', format: 'aac', bitrate: 64, url: `https://ice1.somafm.com/${id}-64-aac` },
    ],
    homepage: `https://somafm.com/${id}/`,
  };
}

const channelDefinitions: readonly ChannelDefinition[] = channelMappings.map(m => createSomaFMChannel(m.channelId));
```

Update SOMAFM_CONFIG to include `api` and `channelDefinitions`.
  </action>
  <verify>npx tsc --noEmit (no type errors)</verify>
  <done>
    - SOMAFM_CONFIG has api config with channelsEndpoint, proxyRequired: true
    - SOMAFM_CONFIG has channelDefinitions array with 49 entries
    - Each channel has streams array with high/medium/low quality options
    - Each channel has image object with small/medium/large URLs
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Radio Paradise channel definitions and registry utilities</name>
  <files>src/config/sources/radio-paradise.ts, src/config/sources/index.ts</files>
  <action>
Part A - Radio Paradise config:

Update Radio Paradise config with channel definitions for 4 channels:

- API config:
  - channelsEndpoint: null (no public channel list API)
  - nowPlayingEndpoint: 'https://api.radioparadise.com/api/now_playing?chan={chanId}' (chanIds: 0=Main, 1=Mellow, 2=Rock, 3=Global)
  - streamUrlTemplate: null (define static streams)
  - proxyRequired: true

- Channel definitions for the 4 channels. Radio Paradise stream URLs:
  - Main Mix (id: rp-main, chan: 0):
    - AAC 320k: https://stream.radioparadise.com/aac-320
    - FLAC: https://stream.radioparadise.com/flac
    - MP3 128k: https://stream.radioparadise.com/mp3-128
  - Mellow Mix (id: rp-mellow, chan: 1):
    - AAC 320k: https://stream.radioparadise.com/mellow-aac-320
    - FLAC: https://stream.radioparadise.com/mellow-flac
    - MP3 128k: https://stream.radioparadise.com/mellow-128
  - Rock Mix (id: rp-rock, chan: 2):
    - AAC 320k: https://stream.radioparadise.com/rock-aac-320
    - FLAC: https://stream.radioparadise.com/rock-flac
    - MP3 128k: https://stream.radioparadise.com/rock-128
  - Global Mix (id: rp-global, chan: 3):
    - AAC 320k: https://stream.radioparadise.com/world-etc-aac-320
    - FLAC: https://stream.radioparadise.com/world-etc-flac
    - MP3 128k: https://stream.radioparadise.com/world-etc-128

Images (Radio Paradise uses album art, use their logo as placeholder):
  - small/medium/large: 'https://img.radioparadise.com/covers/l/B0000024SI.jpg' (their logo cover)

Add `rpChannelId` to each definition for API lookups (0, 1, 2, 3).

Part B - Registry utilities (index.ts):

Add lookup functions to `src/config/sources/index.ts`:

```typescript
export function getChannelDefinition(sourceId: string, channelId: string): ChannelDefinition | undefined

export function getAllChannelDefinitions(): readonly (ChannelDefinition & { sourceId: string })[]
```

These complement the existing `getAllChannelMappings()` for genre info.
  </action>
  <verify>npx tsc --noEmit && npm run build</verify>
  <done>
    - RADIO_PARADISE_CONFIG has api config with nowPlayingEndpoint template
    - RADIO_PARADISE_CONFIG has channelDefinitions for 4 channels
    - Each RP channel has streams with AAC 320k, FLAC, MP3 128k
    - getChannelDefinition() function exists and works
    - getAllChannelDefinitions() function exists and returns all 53 channels with sourceId
    - Build succeeds
  </done>
</task>
</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` succeeds with no type errors
- [ ] `npm run build` succeeds
- [ ] SOMAFM_CONFIG has 49 channel definitions
- [ ] RADIO_PARADISE_CONFIG has 4 channel definitions
- [ ] getAllChannelDefinitions() returns 53 entries
- [ ] Each source has api config with proxyRequired: true
- [ ] TypeScript correctly infers types for all exports
</verification>

<success_criteria>
- Extended type system with ChannelDefinition, StreamDefinition, SourceApiConfig
- SomaFM source has full channel definitions with stream URLs
- Radio Paradise source has full channel definitions with stream URLs
- Registry provides channel lookup functions
- All types are readonly and type-safe
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-source-registry/02-01-SUMMARY.md`:

---
phase: 02-source-registry
plan: 01
subsystem: config
requires: [01-genre-taxonomy]
provides: [source-registry, channel-definitions, stream-urls]
affects: [03-radio-paradise, 04-backend-api]
tags: [typescript, static-config, data-layer]
tech-stack:
  added: []
  patterns: [factory-functions, type-narrowing]
key-decisions:
  - Separate ChannelDefinition from ChannelGenreMapping (different concerns)
  - Stream URLs defined statically, live metadata from API
  - proxyRequired flag for CORS handling
key-files: [src/config/types.ts, src/config/sources/index.ts]
---

# Phase 2 Plan 1: Source Registry System Summary

**[Substantive one-liner about what was accomplished]**

## Accomplishments

- [List what was built]

## Files Created/Modified

| File | Purpose |
|------|---------|
| `src/config/types.ts` | Extended with ChannelDefinition, StreamDefinition, SourceApiConfig |
| `src/config/sources/somafm.ts` | Added 49 channel definitions with stream URLs |
| `src/config/sources/radio-paradise.ts` | Added 4 channel definitions with stream URLs |
| `src/config/sources/index.ts` | Added getChannelDefinition(), getAllChannelDefinitions() |

## Commits

| Hash | Description |
|------|-------------|
| `...` | feat: extend config types with channel definitions and API config |
| `...` | feat: add SomaFM channel definitions with stream URLs |
| `...` | feat: add Radio Paradise definitions and registry utilities |

## Verification Results

- TypeScript compilation: [PASS/FAIL]
- Build: [PASS/FAIL]
- Channel count: [X SomaFM + Y Radio Paradise]

## Decisions Made

1. [Decision and rationale]

## Issues Encountered

[None / List issues]

## Next Phase Readiness

Phase 2 complete. Phase 3 (Radio Paradise Integration) can proceed - stream URLs and API config provide the foundation for backend proxy setup.

---
*Executed: YYYY-MM-DD*
</output>
