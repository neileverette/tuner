---
phase: 03-radio-paradise
plan: 01
type: execute
subsystem: backend
requires: [02-source-registry]
provides: [radio-paradise-proxy, stream-playback]
affects: [04-backend-api]
tags: [express, cors-proxy, streaming, backend]
tech-stack:
  added: []
  patterns: [stream-proxy, url-routing]
estimated-tasks: 4
estimated-time: 30-45min
---

<objective>
Extend Express backend to proxy Radio Paradise streams and API, enabling browser playback without CORS issues.

Purpose: Radio Paradise streams (http://stream.radioparadise.com/*) and API (https://api.radioparadise.com/*) have CORS restrictions. The existing server proxies SomaFM streams. This phase adds Radio Paradise routes.

Output:
- `/api/rp/stream/:channelId` - Proxies Radio Paradise audio streams (AAC/FLAC/MP3)
- `/api/rp/now-playing/:chan` - Proxies Radio Paradise now-playing API
- Verified stream playback for all 4 channels
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-source-registry/02-01-SUMMARY.md
@server/index.js
@src/config/sources/radio-paradise.ts

**From Phase 2 (Source Registry):**
- Radio Paradise channel definitions exist with stream URLs
- `RP_CHANNEL_IDS` maps channel IDs to API chan numbers (0-3)
- Streams: AAC 320k, FLAC, MP3 128k for each of 4 channels
- API: `https://api.radioparadise.com/api/get_block?bitrate=4&info=true&chan={0-3}`

**Stream URL patterns (from Integration Guide):**
- Main: `/aac-320`, `/flac`, `/mp3-128`
- Mellow: `/mellow-320`, `/mellow-flac`, `/mellow-128`
- Rock: `/rock-320`, `/rock-flac`, `/rock-128`
- Global: `/global-320`, `/global-flac`, `/global-128`

**Constraints:**
- API polling: max once per 30 seconds
- Streams are HTTP (not HTTPS) - need http module
- Current server uses HTTPS for SomaFM - needs both http and https
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add Radio Paradise stream proxy endpoint</name>
  <files>server/index.js</files>
  <action>
Add new route `/api/rp/stream/:channelId/:format` to proxy Radio Paradise audio streams.

Channel-to-path mapping:
- `rp-main` + `aac` -> `http://stream.radioparadise.com/aac-320`
- `rp-main` + `flac` -> `http://stream.radioparadise.com/flac`
- `rp-main` + `mp3` -> `http://stream.radioparadise.com/mp3-128`
- `rp-mellow` + `aac` -> `http://stream.radioparadise.com/mellow-320`
- `rp-mellow` + `flac` -> `http://stream.radioparadise.com/mellow-flac`
- `rp-mellow` + `mp3` -> `http://stream.radioparadise.com/mellow-128`
- `rp-rock` + `aac` -> `http://stream.radioparadise.com/rock-320`
- `rp-rock` + `flac` -> `http://stream.radioparadise.com/rock-flac`
- `rp-rock` + `mp3` -> `http://stream.radioparadise.com/rock-128`
- `rp-global` + `aac` -> `http://stream.radioparadise.com/global-320`
- `rp-global` + `flac` -> `http://stream.radioparadise.com/global-flac`
- `rp-global` + `mp3` -> `http://stream.radioparadise.com/global-128`

Use `http.get()` (not https) since Radio Paradise streams are HTTP.
Set Content-Type based on format:
- `aac` -> `audio/aac`
- `flac` -> `audio/flac`
- `mp3` -> `audio/mpeg`

Add User-Agent header for proper stream access.
Return 400 for invalid channelId or format.
  </action>
  <verify>
Start server: `node server/index.js`
Test with curl: `curl -I http://localhost:3001/api/rp/stream/rp-main/aac`
Should return 200 with Content-Type: audio/aac
  </verify>
  <done>
- Route `/api/rp/stream/:channelId/:format` exists
- Returns audio stream with correct Content-Type
- Invalid params return 400
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Radio Paradise now-playing API proxy</name>
  <files>server/index.js</files>
  <action>
Add route `/api/rp/now-playing/:chan` to proxy Radio Paradise metadata API.

The `:chan` param is the numeric channel ID (0-3):
- 0 = Main Mix
- 1 = Mellow Mix
- 2 = Rock Mix
- 3 = Global Mix

Proxy to: `https://api.radioparadise.com/api/get_block?bitrate=4&info=true&chan={chan}`

Use `https.get()` since the API is HTTPS.
Set response Content-Type to `application/json`.
Return 400 if chan is not 0-3.

Note: Do NOT add rate limiting in the server. Rate limiting (30s between requests) is the frontend's responsibility - the server just proxies.
  </action>
  <verify>
Test with curl: `curl http://localhost:3001/api/rp/now-playing/0`
Should return JSON with song data including `artist`, `title`, `album`
  </verify>
  <done>
- Route `/api/rp/now-playing/:chan` exists
- Returns JSON metadata from Radio Paradise API
- Invalid chan returns 400
  </done>
</task>

<task type="auto">
  <name>Task 3: Test all 4 channel streams via proxy</name>
  <files>-</files>
  <action>
Verify each Radio Paradise channel streams correctly through the proxy.

Test sequence (server must be running):
1. Main Mix AAC: `curl -I http://localhost:3001/api/rp/stream/rp-main/aac` -> 200
2. Mellow Mix AAC: `curl -I http://localhost:3001/api/rp/stream/rp-mellow/aac` -> 200
3. Rock Mix AAC: `curl -I http://localhost:3001/api/rp/stream/rp-rock/aac` -> 200
4. Global Mix AAC: `curl -I http://localhost:3001/api/rp/stream/rp-global/aac` -> 200
5. Main Mix FLAC: `curl -I http://localhost:3001/api/rp/stream/rp-main/flac` -> 200
6. Main Mix MP3: `curl -I http://localhost:3001/api/rp/stream/rp-main/mp3` -> 200

Also test error cases:
- Invalid channel: `curl -I http://localhost:3001/api/rp/stream/invalid/aac` -> 400
- Invalid format: `curl -I http://localhost:3001/api/rp/stream/rp-main/wav` -> 400

If any test fails, debug and fix the proxy route.
  </action>
  <verify>All 6 valid stream tests return HTTP 200, both error cases return 400</verify>
  <done>
- All 4 channels stream via AAC format
- FLAC and MP3 formats work for at least one channel
- Error handling works for invalid params
  </done>
</task>

<task type="auto">
  <name>Task 4: Test now-playing API for all channels</name>
  <files>-</files>
  <action>
Verify the now-playing API proxy returns valid metadata for all 4 channels.

Test sequence:
1. `curl http://localhost:3001/api/rp/now-playing/0` - Main Mix
2. `curl http://localhost:3001/api/rp/now-playing/1` - Mellow Mix
3. `curl http://localhost:3001/api/rp/now-playing/2` - Rock Mix
4. `curl http://localhost:3001/api/rp/now-playing/3` - Global Mix

Each response should contain:
- `song` object with track metadata
- Artist and title information

Error test:
- `curl http://localhost:3001/api/rp/now-playing/9` -> 400

If any test fails, debug and fix the proxy route.
  </action>
  <verify>All 4 channels return valid JSON with song data, invalid chan returns 400</verify>
  <done>
- All 4 channels return now-playing metadata
- Response includes song/artist/title data
- Invalid chan param returns 400
  </done>
</task>
</tasks>

<verification>
Before declaring phase complete:
- [ ] Server starts without errors: `node server/index.js`
- [ ] Stream proxy works for all 4 Radio Paradise channels
- [ ] Now-playing API proxy returns metadata for all 4 channels
- [ ] Existing SomaFM proxy still works: `curl -I http://localhost:3001/api/stream/groovesalad`
- [ ] Invalid params return appropriate 400 errors
</verification>

<success_criteria>
- `/api/rp/stream/:channelId/:format` proxies Radio Paradise audio streams
- `/api/rp/now-playing/:chan` proxies Radio Paradise metadata API
- All 4 channels (Main, Mellow, Rock, Global) playable through proxy
- Existing SomaFM functionality unchanged
- No runtime errors in server
</success_criteria>

<output>
After completion, create `.planning/phases/03-radio-paradise/03-01-SUMMARY.md`:

```markdown
---
phase: 03-radio-paradise
plan: 01
subsystem: backend
requires: [02-source-registry]
provides: [radio-paradise-proxy, stream-playback]
affects: [04-backend-api]
tags: [express, cors-proxy, streaming, backend]
tech-stack:
  added: []
  patterns: [stream-proxy, url-routing]
key-decisions:
  - [list decisions made during implementation]
key-files: [server/index.js]
---

# Phase 3 Plan 1: Radio Paradise Integration Summary

**[One-liner summary]**

## Accomplishments

## Files Created/Modified

| File | Purpose |
|------|---------|

## Commits

| Hash | Description |
|------|-------------|

## Verification Results

## Decisions Made

## Issues Encountered

## API Reference

### Radio Paradise Stream Proxy
- Endpoint: `/api/rp/stream/:channelId/:format`
- Channels: `rp-main`, `rp-mellow`, `rp-rock`, `rp-global`
- Formats: `aac`, `flac`, `mp3`

### Radio Paradise Now Playing Proxy
- Endpoint: `/api/rp/now-playing/:chan`
- Channels: 0 (main), 1 (mellow), 2 (rock), 3 (global)

## Next Phase Readiness

---
*Executed: [date]*
```
</output>
